# HELK ecs-to-ossem filter conf
# HELK build Stage: Alpha
# Author: Nate Guagenti (@neu5ron)
# License: GPL-3.0

filter {
    # Network common fields
    if [etl_pipeline] == "syslog-udp-input-fortinet-fos" {
      grok {
          match => ["event_original_message", "%{SYSLOG5424PRI:syslog_index}%{GREEDYDATA:[@metadata][message]}"]
          #overwrite => ["message"]
          tag_on_failure => ["fortinet_grok_failure"]
          remove_field => [ "syslog_index" ]
      }

      if "fortinet_grok_failure" not in [tags] {
        kv {
            source => "[@metadata][message]"
            value_split => "="
            field_split => " "
            #prefix => "fortios." 
        }
      }

      if [tz] {
        grok {
            match => ["tz", "(?<[@metadata][first_three]>^...)"]
            tag_on_failure => ["first_three_grok_failure"]
        }
        grok {
            match => ["tz", "(?<[@metadata][last_two]>..\r?$)"]
            tag_on_failure => ["last_two_grok_failure"]
        }

        mutate  {
            replace => {"[tz]" => "%{[@metadata][first_three]}:%{[@metadata][last_two]}"}
            replace => {"[@metadata][timestamp]" => "%{date} %{time} %{tz}"}
        }
      }

      # forti* without tz: fortiweb, fortimail, forticlient, fortigate 6.0, and any log comming from fortianalyzer
      if ![@metadata][timestamp] {
        mutate{
            add_field => {"[tz]" => "-05:00" }
            add_field => {"[event][timezone]" => "America/Lima" }
            add_tag => [ "setting_default_timezone" ]
            add_field => {"[@metadata][timestamp]" => "%{date} %{time} %{[event][timezone]}"}
        }
      }

      date {
          match => ["[@metadata][timestamp]", "yyyy-MM-dd HH:mm:ss ZZ", "yyyy-MM-dd HH:mm:ss ZZZ", "yyyy-MM-dd HH:mm:ss", "ISO8601"]
          #timezone => "%{[event][timezone]}"
          target => "@timestamp"
          tag_on_failure => ["_dateparsefailure_%{[@metadata][timestamp]}"]
          #add_tag => [ "%{[@metadata][timestamp]}" ]
          remove_field => [ "date","time" ]
          
      }
    }
}